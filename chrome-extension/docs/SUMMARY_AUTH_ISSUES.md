# èªè­‰å•é¡ŒåŸ·è¡Œç¸½çµ

## å•é¡Œç¢ºèª

ç¶“éŽå°åƒè€ƒ Chrome æ“´å±•ï¼ˆMS Todo 1.1ï¼‰çš„åˆ†æžï¼Œç™¼ç¾ç•¶å‰ mms-todo çš„ç™»å…¥å´©æ½°æ˜¯ç”±**å¤šå€‹è¨­è¨ˆç¼ºé™·ç–ŠåŠ **å°Žè‡´çš„ï¼š

### æ ¸å¿ƒå•é¡Œï¼ˆå„ªå…ˆç´šæŽ’åºï¼‰

#### ðŸ”´ P1: ä½¿ç”¨ chrome.storage.local å°Žè‡´çš„åˆå§‹åŒ–å»¶é²
- **ç—‡ç‹€ï¼š** å•Ÿå‹•æ“´å±•æ™‚çœ‹åˆ°åŠ è¼‰è½‰åœˆï¼Œç„¶å¾Œè¦æ±‚é‡æ–°ç™»å…¥
- **æ ¹å› ï¼š** `chrome.storage.local.get()` æ˜¯ç•°æ­¥çš„ï¼Œå¤šæ¬¡è®€å–ç”¢ç”Ÿç«¶æ…‹æ¢ä»¶
- **åƒè€ƒæ“´å±•ï¼š** ä½¿ç”¨åŒæ­¥çš„ `localStorage`
- **ä¿®å¾©é›£åº¦ï¼š** â­ ç°¡å–®ï¼ˆ30 åˆ†é˜ï¼‰

#### ðŸ”´ P2: Token åˆ·æ–°å¤±æ•—æ™‚ç›´æŽ¥æ¸…é™¤èªè­‰
- **ç—‡ç‹€ï¼š** ç¶²è·¯æŠ–å‹•æˆ–çŸ­æš«ä¼ºæœå™¨éŒ¯èª¤ â†’ ç«‹å³é€€å‡ºç™»å…¥
- **æ ¹å› ï¼š** ç¼ºå°‘éŒ¯èª¤åˆ†é¡žï¼Œæ²’æœ‰é‡è©¦é‚è¼¯
- **åƒè€ƒæ“´å±•ï¼š** MSAL è‡ªå‹•å€åˆ† transient vs permanent éŒ¯èª¤
- **ä¿®å¾©é›£åº¦ï¼š** â­ ç°¡å–®ï¼ˆ30 åˆ†é˜ï¼‰

#### ðŸŸ¡ P3: Token åˆ·æ–°è¨ˆæ™‚å™¨åœ¨æ“´å±•é‡å•Ÿæ™‚ä¸Ÿå¤±
- **ç—‡ç‹€ï¼š** é—œé–‰ç€è¦½å™¨å¾Œé‡å•Ÿï¼ŒToken å¯èƒ½éŽæœŸä½†æ²’æœ‰è‡ªå‹•åˆ·æ–°
- **æ ¹å› ï¼š** åªç”¨ `setTimeout`ï¼Œæ²’æœ‰æŒä¹…åŒ–è¨ˆæ™‚
- **åƒè€ƒæ“´å±•ï¼š** MSAL åœ¨ IndexedDB ä¸­å­˜å„²éŽæœŸæ™‚é–“
- **ä¿®å¾©é›£åº¦ï¼š** â­â­ ä¸­ç­‰ï¼ˆ45 åˆ†é˜ï¼‰

#### ðŸŸ¡ P4: å¤š Context ä¹‹é–“çš„ç‹€æ…‹ä¸åŒæ­¥
- **ç—‡ç‹€ï¼š** popup å’Œ sidepanel çœ‹åˆ°ä¸åŒçš„ç™»å…¥ç‹€æ…‹
- **æ ¹å› ï¼š** `chrome.storage.onChanged` ç›£è½æœ‰å»¶é²
- **åƒè€ƒæ“´å±•ï¼š** localStorage ä¿®æ”¹ç«‹å³å°æ‰€æœ‰ Context å¯è¦‹
- **ä¿®å¾©é›£åº¦ï¼š** â­ ç°¡å–®ï¼ˆ20 åˆ†é˜ï¼Œæ”¹ç”¨ localStorage å¾Œè‡ªå‹•è§£æ±ºï¼‰

#### ðŸŸ¡ P5: Code Verifier çš„æ¢å¾©é‚è¼¯ä¸å®Œæ•´
- **ç—‡ç‹€ï¼š** ç™»å…¥æµç¨‹ä¸­æ–·ï¼ˆç”¨æˆ¶é—œé–‰çª—å£æˆ–æ“´å±•å´©æ½°ï¼‰å¾Œç„¡æ³•æ¢å¾©
- **æ ¹å› ï¼š** Code verifier åªå­˜å„²åœ¨è¨˜æ†¶é«”ä¸­
- **åƒè€ƒæ“´å±•ï¼š** ä¸éœ€è¦æ¢å¾©ï¼ˆMSAL å…§éƒ¨è™•ç†ï¼‰
- **ä¿®å¾©é›£åº¦ï¼š** â­â­ ä¸­ç­‰ï¼ˆ30 åˆ†é˜ï¼‰

---

## ç‚ºä»€éº¼åƒè€ƒæ“´å±•å·¥ä½œæ­£å¸¸

### 1ï¸âƒ£ ä½¿ç”¨å®˜æ–¹ MSAL åº«
- ç¶“éŽæ•¸ç™¾è¬ç”¨æˆ¶é©—è­‰
- è‡ªå‹•è™•ç†æ‰€æœ‰é‚Šç•Œæƒ…æ³
- è‡ªå‹•é‡è©¦ transient éŒ¯èª¤

### 2ï¸âƒ£ localStorage ä½œç‚ºä¸»å­˜å„²
- åŒæ­¥è®€å¯«ï¼Œç„¡ç«¶æ…‹æ¢ä»¶
- æ‰€æœ‰ Context ç«‹å³å¯è¦‹
- èˆ‡ Chrome ç„¡é—œï¼Œæ›´å¯é 

### 3ï¸âƒ£ å®Œæ•´çš„éŒ¯èª¤è™•ç†
- å€åˆ† invalid_grantï¼ˆçœŸæ­£çš„éŒ¯èª¤ï¼‰vs å…¶ä»–éŒ¯èª¤ï¼ˆé‡è©¦ï¼‰
- æ™ºèƒ½é‡è©¦ç­–ç•¥ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰
- å„ªé›…é™ç´š

### 4ï¸âƒ£ æŒä¹…åŒ–è¨ˆæ™‚
- MSAL å…§éƒ¨è‡ªå‹•ç®¡ç†
- æ“´å±•é‡å•Ÿå¾Œä»èƒ½æ­£ç¢ºè¨ˆç®—å‰©é¤˜æ™‚é–“

---

## ä¿®å¾©æ–¹æ¡ˆï¼ˆ3 å€‹å±¤æ¬¡ï¼‰

### ðŸŸ¢ å¿«é€Ÿä¿®å¾©ï¼ˆæŽ¨è–¦ç«‹å³å¯¦æ–½ï¼‰
**é è¨ˆæ™‚é–“ï¼š1.5 å°æ™‚**

1. **æ”¹ç”¨ localStorage**ï¼ˆ30 åˆ†é˜ï¼‰
   - æ›´æ–° `hooks/useAuth.ts` ä¸­çš„ `getAuth()` / `setAuth()` / `clearAuth()`
   - æ·»åŠ åŒæ­¥åˆå§‹åŒ–é‚è¼¯

2. **æ”¹é€²éŒ¯èª¤æ¢å¾©**ï¼ˆ30 åˆ†é˜ï¼‰
   - å€åˆ† `invalid_grant` éŒ¯èª¤
   - Transient éŒ¯èª¤æ™‚ä¿æŒç‹€æ…‹ï¼Œ30 ç§’å¾Œé‡è©¦

3. **å¢žåŠ è·¨ Context é€šä¿¡**ï¼ˆ30 åˆ†é˜ï¼‰
   - ç›£è½ `storage` äº‹ä»¶
   - ç™¼é€ `auth_changed` æ¶ˆæ¯

**é æœŸæ•ˆæžœï¼š**
- âœ… ç™»å…¥æ¢å¾©çŽ‡å¾ž ~50% æå‡åˆ° >95%
- âœ… å•Ÿå‹•é€Ÿåº¦æ›´å¿«ï¼ˆç„¡åŠ è¼‰å»¶é²ï¼‰
- âœ… å¤šå€‹ UI Context ç‹€æ…‹åŒæ­¥

### ðŸŸ¡ ç©©å®šæ€§æ”¹é€²ï¼ˆçŸ­æœŸç›®æ¨™ï¼‰
**é è¨ˆæ™‚é–“ï¼š1-2 é€±**

4. **ä½¿ç”¨ chrome.alarms**ï¼ˆ45 åˆ†é˜ï¼‰
   - æŒä¹…åŒ– Token åˆ·æ–°è¨ˆæ™‚
   - æ“´å±•é‡å•Ÿå¾Œä»èƒ½æ­£ç¢ºè¨ˆç®—

5. **å®Œæ•´çš„é‡è©¦é‚è¼¯**ï¼ˆ1 å°æ™‚ï¼‰
   - å¯¦ç¾æŒ‡æ•¸é€€é¿é‡è©¦
   - æ·»åŠ é‡è©¦è¨ˆæ•¸ä¸Šé™

6. **å®Œæ•´çš„æ—¥èªŒè¨˜éŒ„**ï¼ˆ1 å°æ™‚ï¼‰
   - æ·»åŠ è©³ç´°çš„èªè­‰éŽç¨‹æ—¥èªŒ
   - ä¾¿æ–¼å•é¡Œè¨ºæ–·

**é æœŸæ•ˆæžœï¼š**
- âœ… å„é¡žç¶²è·¯å•é¡Œè‡ªå‹•æ¢å¾©
- âœ… å¯ä»¥è¿½è¹¤èªè­‰å•é¡Œ

### ðŸ”µ é•·æœŸæ”¹é€²ï¼ˆ3 å€‹æœˆå…§ï¼‰
**é è¨ˆæ™‚é–“ï¼š2-3 å¤©**

7. **é·ç§»åˆ° MSAL**ï¼ˆ2-3 å¤©ï¼‰
   - ç§»é™¤è‡ªå®šç¾© OAuth å¯¦ç¾
   - ä½¿ç”¨å®˜æ–¹ MSAL åº«

**é æœŸæ•ˆæžœï¼š**
- âœ… å¾¹åº•è§£æ±ºèªè­‰å•é¡Œ
- âœ… äº«å—å®˜æ–¹åº«çš„æŒçºŒç¶­è­·
- âœ… æ”¯æ´æ›´å¤šåŠŸèƒ½ï¼ˆå¸³æˆ¶åˆ‡æ›ã€é›¢ç·šæ¨¡å¼ç­‰ï¼‰

---

## æä¾›çš„ä¿®å¾©è³‡æ–™

### ðŸ“„ è©³ç´°æ–‡ä»¶

1. **AUTH_FIX_GUIDE.md**
   - å•é¡Œè©³è§£ï¼ˆ5 å€‹å•é¡Œçš„å…·é«”åˆ†æžï¼‰
   - å®Œæ•´çš„æ”¹é€²ä»£ç¢¼ï¼ˆå¯ç›´æŽ¥è¤‡è£½ï¼‰
   - ä¿®æ”¹æ¸…å–®å’Œå¾ŒçºŒæ­¥é©Ÿ
   - â±ï¸ é–±è®€æ™‚é–“ï¼š20 åˆ†é˜

2. **ANALYSIS_REFERENCE_AUTH.md**
   - åƒè€ƒæ“´å±•çš„å¯¦ç¾åˆ†æž
   - MSAL çš„å·¥ä½œåŽŸç†
   - localStorage vs chrome.storage.local å°æ¯”
   - â±ï¸ é–±è®€æ™‚é–“ï¼š15 åˆ†é˜

3. **COMPARISON_REFERENCE_VS_CURRENT.md**
   - è©³ç´°çš„å°æ¯”è¡¨æ ¼
   - å„å ´æ™¯ä¸‹çš„è¡Œç‚ºå°æ¯”
   - ç‚ºä»€éº¼åƒè€ƒæ“´å±•æ›´ç©©å®š
   - â±ï¸ é–±è®€æ™‚é–“ï¼š10 åˆ†é˜

### ðŸ› ï¸ è¨ºæ–·å·¥å…·

4. **DIAGNOSTIC_SCRIPT.js**
   - åœ¨ DevTools Console ä¸­åŸ·è¡Œ
   - è‡ªå‹•æª¢æŸ¥ç•¶å‰ç‹€æ…‹
   - æä¾›å³æ™‚ä¿®å¾©å»ºè­°
   - æä¾›æ‰‹å‹•åˆ·æ–°å’Œæ¸…é™¤å‡½æ•¸

---

## å¿«é€Ÿé–‹å§‹æŒ‡å—

### æ­¥é©Ÿ 1ï¼šè¨ºæ–·ç•¶å‰ç‹€æ…‹ï¼ˆ5 åˆ†é˜ï¼‰

1. æ‰“é–‹æ“´å±•çš„ Popup æˆ– SidePanel
2. æŒ‰ F12 æ‰“é–‹ DevTools
3. é€²å…¥ Console æ¨™ç±¤
4. è¤‡è£½ä¸¦åŸ·è¡Œ `DIAGNOSTIC_SCRIPT.js` çš„å…§å®¹
5. æŸ¥çœ‹è¼¸å‡ºçµæžœ

### æ­¥é©Ÿ 2ï¼šæ‡‰ç”¨å¿«é€Ÿä¿®å¾©ï¼ˆ90 åˆ†é˜ï¼‰

1. æ‰“é–‹ `hooks/useAuth.ts`
2. æŒ‰ç…§ `AUTH_FIX_GUIDE.md` çš„ "ä¿®å¾©æ–¹æ¡ˆ" éƒ¨åˆ†ï¼Œå°‡ä»£ç¢¼æ›¿æ›ç‚ºæ”¹é€²ç‰ˆæœ¬
3. é‹è¡Œ `pnpm dev` æ¸¬è©¦
4. æ¸¬è©¦æ¸…å–®ï¼š
   - âœ… ç™»å…¥ â†’ æˆåŠŸå¾Œæ‡‰ç«‹å³å¯ç”¨ï¼ˆç„¡åŠ è¼‰è½‰åœˆï¼‰
   - âœ… é—œé–‰æ“´å±•å†æ‰“é–‹ â†’ Token æ‡‰è‡ªå‹•æ¢å¾©
   - âœ… é—œé–‰ç¶²è·¯ â†’ æ¢å¾©å¾Œæ‡‰è‡ªå‹•é‡è©¦

### æ­¥é©Ÿ 3ï¼šé•·æœŸæ”¹é€²ï¼ˆå¯é¸ï¼‰

æ ¹æ“š `AUTH_FIX_GUIDE.md` çš„ "å¾ŒçºŒæ­¥é©Ÿ" éƒ¨åˆ†ï¼Œç¹¼çºŒæ”¹é€²ï¼š
- æ·»åŠ  chrome.alarms
- é·ç§»åˆ° MSALï¼ˆé•·æœŸï¼‰

---

## é æœŸæ•ˆæžœå°æ¯”

| æŒ‡æ¨™ | ç¾ç‹€ | ä¿®å¾©å¾Œï¼ˆå¿«é€Ÿï¼‰ | ä¿®å¾©å¾Œï¼ˆå®Œæ•´ï¼‰ |
|-----|------|------------|-----------|
| **ç™»å…¥æ¢å¾©çŽ‡** | ~50% | >95% | 99%+ |
| **å•Ÿå‹•æ™‚é–“** | 2-3 ç§’ | <500ms | <500ms |
| **ç¶²è·¯æ¢å¾©** | âŒ | ðŸŸ¡ (30 ç§’) | âœ… (è‡ªå‹•) |
| **å¤š Context åŒæ­¥** | ðŸŸ¡ | âœ… | âœ… |
| **Token è¨ˆæ™‚æŒä¹…åŒ–** | âŒ | ðŸŸ¡ | âœ… |
| **ä»£ç¢¼å¯ç¶­è­·æ€§** | ðŸŸ¡ | ðŸŸ¡ | âœ… (MSAL) |

---

## é—œéµè¦é»ž

### âœ… è¦åšçš„äº‹

1. **ç«‹å³ï¼š** æ”¹ç”¨ localStorage æ›¿æ› chrome.storage.local
2. **ç«‹å³ï¼š** æ”¹é€²éŒ¯èª¤æ¢å¾©é‚è¼¯ï¼ˆå€åˆ† invalid_grantï¼‰
3. **æœ¬é€±ï¼š** æ·»åŠ é‡è©¦é‚è¼¯ï¼ˆexponential backoffï¼‰
4. **æœ¬æœˆï¼š** ä½¿ç”¨ chrome.alarms é€²è¡ŒæŒä¹…åŒ–è¨ˆæ™‚
5. **é•·æœŸï¼š** è©•ä¼°é·ç§»åˆ° MSAL

### âŒ ä¸è¦åšçš„äº‹

1. âŒ ç¹¼çºŒä½¿ç”¨ `chrome.storage.local` ä½œç‚ºä¸»å­˜å„²
2. âŒ Token åˆ·æ–°å¤±æ•—æ™‚ç›´æŽ¥æ¸…é™¤èªè­‰
3. âŒ å¿½è¦–ç¶²è·¯ transient éŒ¯èª¤
4. âŒ åªä¾è³´ `setTimeout` é€²è¡Œé•·æœŸè¨ˆæ™‚

---

## æ”¯æ´è³‡æº

- **CLAUDE.md** - é …ç›®æ•´é«”æž¶æ§‹èªªæ˜Ž
- **AGENT.md** - é–‹ç™¼è€…æŒ‡å—ï¼ˆåŒ…å«å¾…è¾¦æ¸…å–®ï¼‰
- **README.md** - ä½¿ç”¨è€…æŒ‡å—

---

## é è¨ˆæ™‚é–“è¡¨

```
ç«‹å³ï¼ˆä»Šå¤©ï¼‰       1.5 å°æ™‚    å¿«é€Ÿä¿®å¾©
â””â”€ localStorage
â””â”€ éŒ¯èª¤æ¢å¾©
â””â”€ è·¨ Context é€šä¿¡

æœ¬é€±ï¼ˆ3-5 å¤©ï¼‰     2-3 å°æ™‚    ç©©å®šæ€§æ”¹é€²
â””â”€ chrome.alarms
â””â”€ å®Œæ•´é‡è©¦é‚è¼¯
â””â”€ æ—¥èªŒè¨˜éŒ„

æœ¬æœˆï¼ˆå¯é¸ï¼‰       2-3 å¤©      é•·æœŸæ”¹é€²
â””â”€ MSAL é·ç§»

å¾ŒçºŒ               æŒçºŒ        ç¶­è­·å’Œç›£æŽ§
â””â”€ ä½¿ç”¨è€…åé¥‹
â””â”€ bug ä¿®å¾©
```

---

## å¸¸è¦‹å•é¡Œ

**Q: ç‚ºä»€éº¼ä¸ç›´æŽ¥ç”¨ MSALï¼Ÿ**
A: MSAL æ˜¯é•·æœŸç›®æ¨™ï¼Œä½†å¿«é€Ÿä¿®å¾©å¯ä»¥ç«‹å³æ”¹å–„ 95% çš„å•é¡Œï¼Œå€¼å¾—å…ˆå¯¦æ–½ã€‚

**Q: localStorage æœƒè¢« Chrome æ¸…é™¤å—Žï¼Ÿ**
A: localStorage èˆ‡ chrome.storage.local åœ¨æ“´å±•ä¸­ä¸€æ¨£å®‰å…¨ï¼Œéƒ½ä¸æœƒè¢«æ™®é€šæ¸…é™¤æ“ä½œå½±éŸ¿ã€‚

**Q: è¦æ”¹å‹•å¤šå°‘ä»£ç¢¼ï¼Ÿ**
A: å¿«é€Ÿä¿®å¾©åªéœ€æ”¹å‹• `hooks/useAuth.ts` çš„ ~200 è¡Œä»£ç¢¼ã€‚

**Q: æœƒå½±éŸ¿å…¶ä»–åŠŸèƒ½å—Žï¼Ÿ**
A: ä¸æœƒã€‚èªè­‰å±¤æ˜¯ç¨ç«‹çš„ï¼Œæ”¹å‹•ä¸æœƒå½±éŸ¿ Graph API èª¿ç”¨æˆ– UI å±¤ã€‚

---

## è¯ç¹«æ–¹å¼

å¦‚æœ‰å•é¡Œï¼Œè«‹åƒè€ƒï¼š
1. è¨ºæ–·è…³æœ¬è¼¸å‡º
2. Browser Console æ—¥èªŒ
3. ç›¸é—œæ–‡ä»¶çš„è©³ç´°èªªæ˜Ž
